name: "Continuous Integration (website)"

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'website/**'
  push:
    branches:
      - main
    paths: 
      - 'website/**'

permissions:
  contents: read

defaults:
  run:
    shell: bash
    working-directory: website/

jobs:
  check:
    name: Check
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ‡³ Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "24.13.0"
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: âš’ï¸ Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3
        with:
          just-version: "1.40.0"            

      - name: âš™ï¸ Install dependencies
        run: just ci

      - name: ðŸ” Check lints and formatting
        run: just check

  test:
    name: Test
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ‡³ Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "24.13.0"
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: âš’ï¸ Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3
        with:
          just-version: "1.40.0"

      - name: âš™ï¸ Install dependencies
        run: just ci

      - name: ðŸ§ª Run tests
        run: just test

      - name: â¬†ï¸ Upload coverage report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: test-coverage
          path: website/coverage/

  build:
    needs: [test, check]
    name: Build
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ‡³ Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "24.13.0"
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: âš’ï¸ Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3
        with:
          just-version: "1.40.0"            

      - name: âš™ï¸ Install dependencies
        run: just ci

      - name: ðŸ—ï¸ Build production output
        run: just build

      - name: â¬†ï¸ Upload static website artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: website-${{ github.sha }}
          path: website/dist/website/

  test-e2e:
    name: Test E2E (${{ matrix.browser }})
    runs-on: ubuntu-24.04
    needs: build
    container:
      image: mcr.microsoft.com/playwright:v1.58.1-noble@sha256:feae0b1581609d3dc2ba22567b4703dd6a3e7a219984bb86a19ed35007148a91
    strategy:
      fail-fast: false
      matrix:
        browser:
          [
            chromium,
            firefox,
            webkit,
            mobile-chrome,
            mobile-safari,
            microsoft-edge,
            google-chrome,
          ]
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ‡³ Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "24.13.0"
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: âš’ï¸ Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3
        with:
          just-version: "1.40.0"

      - name: âš™ï¸ Install dependencies
        run: just ci

      - name: ðŸ’¾ Cache Playwright browsers
        id: cache-playwright-browsers
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/playwright.config.ts') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: âš™ï¸ Setup Microsoft Edge
        if: matrix.browser == 'microsoft-edge'
        run: npx playwright install msedge

      - name: âš™ï¸ Setup Google Chrome
        if: matrix.browser == 'google-chrome'
        run: npx playwright install chrome

      - name: â¬‡ï¸ Download generated distribution
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: website-${{ github.sha }}
          path: website/dist/website

      - name: ðŸ§ª Run E2E tests
        run: just test-e2e-on ${{ matrix.browser }}
        env:
          CI: "true"
          HOME: /root

      - name: â¬†ï¸ Upload coverage report
        if: matrix.browser == 'chromium'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: test-e2e-coverage-${{ matrix.browser }}
          path: website/e2e-tests-report/coverage/ui-lcov.info

  sonar:
    needs: [test, test-e2e, check]
    name: Sonar
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: â¬‡ï¸ Download test coverage report
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: test-coverage
          path: website/coverage/

      - name: â¬‡ï¸ Download test-e2e coverage report
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: test-e2e-coverage-chromium
          path: website/e2e-tests-report/coverage

      - name: ðŸ’¾ Cache SonarCloud packages
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-sonar

      - name: ðŸ·ï¸ Get package version
        id: get_version
        run: |
          VERSION=$(node -p 'require("./package.json").version')
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

      - name: ðŸ” SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        with:
          projectBaseDir: website
          args: >
            -Dsonar.scm.revision=${{ github.sha }}
            -Dsonar.projectVersion=${{ steps.get_version.outputs.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_KAIZEN_WEBSITE }}
