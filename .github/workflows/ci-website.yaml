name: "Continuous Integration (website)"

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'website/**'
  push:
    branches:
      - main
    paths: 
      - 'website/**'

permissions:
  contents: read

defaults:
  run:
    shell: bash
    working-directory: website/

jobs:
  check:
    name: Check
    runs-on: ubuntu-24.04
    steps:
      - name: 🛡️ Harden the runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: 📦 Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0

      - name: 📦 Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: 🇳 Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6
        with:
          node-version: "22.20.0"
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: ⚒️ Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3
        with:
          just-version: "1.40.0"            

      - name: ⚙️ Install dependencies
        run: just ci

      - name: 🔍 Check lints and formatting
        run: just check

  test:
    name: Test
    runs-on: ubuntu-24.04
    steps:
      - name: 🛡️ Harden the runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: 📦 Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0

      - name: 📦 Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: 🇳 Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6
        with:
          node-version: "22.20.0"
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: ⚒️ Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3
        with:
          just-version: "1.40.0"

      - name: ⚙️ Install dependencies
        run: just ci

      - name: 🧪 Run tests
        run: just test

      - name: ⬆️ Upload coverage report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: test-coverage
          path: website/coverage/

  build:
    needs: [test, check]
    name: Build
    runs-on: ubuntu-24.04
    steps:
      - name: 🛡️ Harden the runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: 📦 Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0

      - name: 📦 Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: 🇳 Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6
        with:
          node-version: "22.20.0"
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: ⚒️ Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3
        with:
          just-version: "1.40.0"            

      - name: ⚙️ Install dependencies
        run: just ci

      - name: 🏗️ Build production output
        run: just build

      - name: ⬆️ Upload static website artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: website-${{ github.sha }}
          path: website/dist/website/

  test-e2e:
    name: Test E2E (${{ matrix.browser }})
    runs-on: ubuntu-24.04
    needs: build
    container:
      image: mcr.microsoft.com/playwright:v1.56.0-noble@sha256:35246d87a7c88ea9b771c65d33171b2611b02a8253b4b12ce6f94376c55f99f2
    strategy:
      fail-fast: false
      matrix:
        browser:
          [
            chromium,
            firefox,
            webkit,
            mobile-chrome,
            mobile-safari,
            microsoft-edge,
            google-chrome,
          ]
    steps:
      - name: 🛡️ Harden the runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: 📦 Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0

      - name: 📦 Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: 🇳 Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6
        with:
          node-version: "22.20.0"
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: ⚒️ Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3
        with:
          just-version: "1.40.0"

      - name: ⚙️ Install dependencies
        run: just ci

      - name: 💾 Cache Playwright browsers
        id: cache-playwright-browsers
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/playwright.config.ts') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: ⚙️ Setup Microsoft Edge
        if: matrix.browser == 'microsoft-edge'
        run: npx playwright install msedge

      - name: ⚙️ Setup Google Chrome
        if: matrix.browser == 'google-chrome'
        run: npx playwright install chrome

      - name: ⬇️ Download generated distribution
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: website-${{ github.sha }}
          path: website/dist/website

      - name: 🧪 Run E2E tests
        run: just test-e2e-on ${{ matrix.browser }}
        env:
          CI: "true"
          HOME: /root

      - name: ⬆️ Upload coverage report
        if: matrix.browser == 'chromium'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: test-e2e-coverage-${{ matrix.browser }}
          path: website/e2e-tests-report/coverage/ui-lcov.info

  sonar:
    needs: [test, test-e2e, check]
    name: Sonar
    runs-on: ubuntu-24.04
    steps:
      - name: 🛡️ Harden the runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: 📦 Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0

      - name: 📦 Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ⬇️ Download test coverage report
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: test-coverage
          path: website/coverage/

      - name: ⬇️ Download test-e2e coverage report
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: test-e2e-coverage-chromium
          path: website/e2e-tests-report/coverage

      - name: 💾 Cache SonarCloud packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-sonar

      - name: 🏷️ Get package version
        id: get_version
        run: |
          VERSION=$(node -p 'require("./package.json").version')
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

      - name: 🔍 SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602 # v6.0.0
        with:
          projectBaseDir: website
          args: >
            -Dsonar.scm.revision=${{ github.sha }}
            -Dsonar.projectVersion=${{ steps.get_version.outputs.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_KAIZEN_WEBSITE }}
